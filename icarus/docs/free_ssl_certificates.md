# SSL Certificates for Lambda and FE custom domains

Unless you have a paid SSL certificate for your custom domain, here are two procedures to have one for free.

1. Using [Let's encrypt](https://letsencrypt.org):
2. Using AWS Certificate Manager issued 

|                            | Let's Encrypt  |  ACM   |
|----------------------------|----------------|--------|
| Expiration                 | 3 month        | 1 year |
| Allows wildcard subdomains | No             | Yes    |
| Requires domain MX setup   | No             | Yes    |

I assume the base domain is hosted by Route53 in both cases.

## Let's Encrypt

Let's Encrypt generates a signed certificate from a web server machine publicly accessible from the Internet as http and https.

The server must be addressable with all DNS names you want to create a certificate for.

An easy way is creating a temporary EC2 Instance.

1. Start an EC2 instance:
    * `t2.micro`
    * Public IP; accessible from the Internet on `http` and `https`
    * Security Group: Must access the Internet (i.e. public subnet -> NAT Gateway)
    * I'm using Ubuntu 16.04, but any OS & distro supported by [Certbot](https://certbot.eff.org/) will work. We are using it only for generating the certificates, so the distro and the web server really don't matter!

2. Add DNS `A` (or `CNAME`) records to the zone, for all subdomains you want to create the certificate for. All records must point to the instance public IP
3. Install Apache httpd on the instance. 
    `sudo apt-get update; sudo apt-get install apache2`

4. Follow instructons for running Certbot on the OS installed on the instsance: https://certbot.eff.org/#ubuntuxenial-apache
    * The *Let's Encrypt* will access Apache to verify your identity, so don't run Certbot with `certonly`
    * When asked for domain names, add the subdomains you are going to use, space separated (wildcard domains are not supported, unfortunately)
    * Select "No redirect" on the last question.

5. Download the certificats, private key and credentials directory generated by certbot
    * Don't forget the credentials directory `/etc/letsencrypt`. You will need it to renew the certificate!

6. You may now safely terminate the EC2 instance

7. Import the certificate in ACM
    * Open the files and copy&paste the content
    * `privkey.pem`: Certificate Private Key
    * `fullchain.pem`: The first part is the Certificate Body, the second is the Certificate Chain


Keep the private key and `/etc/letsencrypt` content in a safe place


## Amazon Certificate Manager

**AFAIK, this is limited to `us-east-1` Region only** (at least on November 2017)

Generating a free signed certificate with ACM requires controlling the domain email as ACM sends a verification email to `admin@<domain>`.

If you don't control the domain email it is still possible to set up receiving email with AWS SES and drop incoming messages to an S3 bucket.

The process is bases on [this article](https://medium.com/@sbuckpesch/setup-aws-s3-static-website-hosting-using-ssl-acm-34d41d32e394), but I assume we are not creating an S3 bucket for hosting a website.

I assume the domain is already hosted on Route53 but no MX is set up.

**Attention**: if you have MX in your domain this process will overwrite them!

Using AWS Console:

1. Set up SES to receive email for your domain (this also sets up Route53)
    * SES > Domains > Verify a New Domain
        * Check *Generate DKIM Settings*
        * The domain must already be hosted on Route
    
    * *Verify this Domain* > *Use Route53*
        * No need to add the DNS records manually: AWS Console will do everything automatically
        * The new domain should be addedd and quckly "verified"

    * Check the Domain on Route53 to verify the `MX` record has been added

2. Create a SES Rule to receive `admib@<domain>` emails
    * SES > Rule Sets : Create a new Rule Set and select *Make rule set active*
        * If you do not activate the Rule Set you have to do it later

    * Create new Rule
        1. Add the following recipients:
            * `admin@<domain>`
            * `administrator@<domain>`

        2. *Next Step*
        3. Add Action: S3
            * S3 Bucket: *Create S3 Bucket*; pick a meaningful name for the bucket (e.g. `<domain>-mail`). It will not be publicly accessible
            * Creating a bucket guarantees it will have a correct Bucket Policy to receive email from SES
            * **Do not** select *Encrypt Message*
        
        4. *Next Step*
        5. Pick a meaningful name for the Rule (e.g. `admin_<domain>-to-s3`)
        4. *Next Step*, *Create Rule*

3. Verify emails are correctly delivered to the Bucket
    * The process drops an an object named `AMAZON_SES_SETUP_NOTIFICATION` in the bucket. **This does not guarantee everything is set up correctly**
    * Send an email to `admin@<domain>` from any other email address
    * An object should appear in the S3 bucket after few seconds. Download it and verify it contains your email

4. Request a certificate using ACM
    * Certificate Manager > Request a certificate
    * Add all domain names you want to generate the certificate for. **Wildcard subdomains are alloed**
    * *Review the request*; *Confirm and request*
    * The Certificate entry will be created in *Verifiication Pending* status

5. Verify the ownership of the domain using the link sent in the email
    * Go to the S3 bucket receiving `admin@<domain>` emails
    * A new object should apprear in the bucket: download it.
    * Find the link to "approve the request", open it in a browser and *Approve* it

6. The certificate should become *Issued*